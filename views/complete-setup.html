<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/css/login.css">
    <title>Complete Setup - Open Word</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid #ddd;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logo-preview {
            margin-top: 10px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .logo-preview img {
            max-width: 150px;
            max-height: 150px;
        }

        small {
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 5px;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background-color: #007bff;
        }

        .step-label {
            font-size: 14px;
            color: #333;
        }

        .step-divider {
            width: 40px;
            height: 2px;
            background-color: #ccc;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e9ecef;
            border-radius: 3px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: #007bff;
            transition: width 0.3s ease;
        }

        /* Client Preview Mockup */
        .preview-section {
            background-color: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .preview-section h3 {
            margin-top: 0;
            color: #495057;
            text-align: center;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .preview-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
        }

        .phone-mockup {
            width: 300px;
            height: 550px;
            border: 8px solid #333;
            border-radius: 30px;
            background: white;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .phone-notch {
            width: 150px;
            height: 25px;
            background: #333;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 0 0 15px 15px;
        }

        .phone-content {
            padding: 35px 20px 20px;
            height: 100%;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .mockup-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            position: relative;
        }

        .mockup-logo::after {
            content: 'YOUR LOGO';
            font-size: 10px;
        }

        .mockup-greeting {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            text-align: center;
            position: relative;
        }

        .mockup-welcome {
            font-size: 14px;
            color: #666;
            text-align: center;
            line-height: 1.4;
            position: relative;
        }

        .mockup-languages {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
            position: relative;
        }

        .mockup-language-btn {
            background: #007bff;
            color: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            font-weight: 500;
        }

        .mockup-waiting {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            text-align: center;
            margin-top: 10px;
            position: relative;
        }

        .preview-labels {
            display: flex;
            flex-direction: column;
            gap: 20px;
            justify-content: center;
        }

        .preview-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .label-indicator {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .label-text {
            color: #495057;
        }

        .label-text strong {
            color: #212529;
        }

        @media (max-width: 768px) {
            .preview-container {
                flex-direction: column;
                align-items: center;
            }

            .phone-mockup {
                width: 280px;
                height: 500px;
            }
        }
    </style>
</head>

<body style="margin: 20px;">
    <div class="container">
        <img src="/img/logo.png" alt="Logo" class="logo">
        <h1>Open Word</h1>
        <p style="text-align: center; color: #666; margin-bottom: 10px;">Complete Your Organization Setup</p>

        <!-- Client Screen Preview -->
        <div class="preview-section">
            <h3>ðŸ“± Preview: How Your Settings Appear on Participant Devices</h3>
            <div class="preview-container">
                <div class="phone-mockup">
                    <div class="phone-notch"></div>
                    <div class="phone-content">
                        <div class="mockup-logo" data-label="1"></div>
                        <div class="mockup-greeting" data-label="2">Welcome!</div>
                        <div class="mockup-welcome" data-label="3" style="font-size: 14px; line-height: 1.6; color: #333;">
                            â€¢ Thank you for joining us today<br>
                            â€¢ Please select your language below<br>
                            â€¢ Translation will begin shortly
                        </div>
                        <div class="mockup-languages" data-label="4">
                            <div class="mockup-language-btn">ðŸ‡ªðŸ‡¸ Spanish</div>
                            <div class="mockup-language-btn">ðŸ‡«ðŸ‡· French</div>
                            <div class="mockup-language-btn">ðŸ‡©ðŸ‡ª German</div>
                        </div>
                        <div class="mockup-waiting" data-label="5">Service is currently offline</div>
                    </div>
                </div>

                <div class="preview-labels">
                    <div class="preview-label">
                        <div class="label-indicator">1</div>
                        <div class="label-text"><strong>Your Logo</strong><br>Uploaded image appears here</div>
                    </div>
                    <div class="preview-label">
                        <div class="label-indicator">2</div>
                        <div class="label-text"><strong>Greeting Text</strong><br>Main welcome message</div>
                    </div>
                    <div class="preview-label">
                        <div class="label-indicator">3</div>
                        <div class="label-text"><strong>Welcome Messages</strong><br>Bullet points shown below greeting</div>
                    </div>
                    <div class="preview-label">
                        <div class="label-indicator">4</div>
                        <div class="label-text"><strong>Translation Languages</strong><br>Languages you selected (1-5)</div>
                    </div>
                    <div class="preview-label">
                        <div class="label-indicator">5</div>
                        <div class="label-text"><strong>Offline Message</strong><br>Shown when service is inactive</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step">
                <div class="step-number">âœ“</div>
                <span class="step-label">Account</span>
            </div>
            <div class="step-divider"></div>
            <div class="step">
                <div class="step-number">âœ“</div>
                <span class="step-label">Verified</span>
            </div>
            <div class="step-divider"></div>
            <div class="step active">
                <div class="step-number">3</div>
                <span class="step-label">Organization</span>
            </div>
        </div>

        <div id="error-message" class="error-message"></div>

        <form id="setup-form" class="validated-form" novalidate>
            <!-- Organization Details -->
            <div class="form-section">
                <h2>Organization Details</h2>

                <div class="form-group">
                    <label for="churchName">Organization/Church Name *</label>
                    <input type="text" id="churchName" name="churchName"
                        placeholder="First Community Church" required>
                </div>

                <div class="form-group">
                    <label for="contactName">Contact Person Name *</label>
                    <input type="text" id="contactName" name="contactName" placeholder="John Smith" required>
                </div>

                <div class="form-group">
                    <label for="contactPhone">Contact Phone</label>
                    <input type="tel" id="contactPhone" name="contactPhone" placeholder="+1 (555) 123-4567">
                </div>
            </div>

            <!-- Language Configuration -->
            <div class="form-section">
                <h2>Language Configuration</h2>

                <div class="form-group">
                    <label for="hostLanguage">Host Language *</label>
                    <select id="hostLanguage" name="hostLanguage" required>
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish (Spain)</option>
                        <option value="es-MX">Spanish (Mexico)</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese (Brazil)</option>
                        <option value="pt-PT">Portuguese (Portugal)</option>
                    </select>
                    <small>The primary language spoken during your services</small>
                </div>

                <div class="form-group">
                    <label>Translation Languages * (Select 1-5 languages)</label>
                    <div class="checkbox-grid" id="language-checkboxes">
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Arabic" data-locale="ar-001"> Arabic
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Bengali" data-locale="bn-BD"> Bengali
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Chinese (Simplified)" data-locale="zh-CN"> Chinese (Simplified)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Chinese (Traditional)" data-locale="zh-TW"> Chinese (Traditional)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Dutch" data-locale="nl-NL"> Dutch
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="English" data-locale="en-US"> English
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="English (UK)" data-locale="en-GB"> English (UK)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Filipino" data-locale="tl-PH"> Filipino
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="French" data-locale="fr-FR"> French
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="German" data-locale="de-DE"> German
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Greek" data-locale="el-GR"> Greek
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Hebrew" data-locale="he-IL"> Hebrew
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Hindi" data-locale="hi-IN"> Hindi
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Indonesian" data-locale="id-ID"> Indonesian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Italian" data-locale="it-IT"> Italian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Japanese" data-locale="ja-JP"> Japanese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Korean" data-locale="ko-KR"> Korean
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Persian" data-locale="fa-IR"> Persian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Polish" data-locale="pl-PL"> Polish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Portuguese" data-locale="pt-PT"> Portuguese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Portuguese (Brazil)" data-locale="pt-BR"> Portuguese (Brazil)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Russian" data-locale="ru-RU"> Russian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Spanish" data-locale="es-ES"> Spanish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Spanish (Latin America)" data-locale="es-419"> Spanish (Latin America)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Spanish (Mexico)" data-locale="es-MX"> Spanish (Mexico)
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Swahili" data-locale="sw-KE"> Swahili
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Thai" data-locale="th-TH"> Thai
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Turkish" data-locale="tr-TR"> Turkish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Ukrainian" data-locale="uk-UA"> Ukrainian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Urdu" data-locale="ur-PK"> Urdu
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" data-name="Vietnamese" data-locale="vi-VN"> Vietnamese
                        </label>
                    </div>
                    <small id="language-counter">Select 1-5 languages you want to offer translation for (0 selected)</small>
                </div>
            </div>

            <!-- Welcome Messages -->
            <div class="form-section">
                <h2>Welcome Messages (Optional)</h2>

                <div class="form-group">
                    <label for="greeting">Greeting Text</label>
                    <input type="text" id="greeting" name="greeting" value="Welcome!"
                        placeholder="Welcome to our service!">
                    <small>Shown at the top of the participant app</small>
                </div>

                <div class="form-group">
                    <label for="welcomeMessages">Welcome Messages</label>
                    <textarea id="welcomeMessages" name="welcomeMessages"
                        placeholder="Enter each message on a new line:&#10;Thank you for joining us today&#10;Please select your language below&#10;Translation will begin shortly" rows="5"></textarea>
                    <small>Enter each message on a separate line. These will appear below the greeting.</small>
                </div>

                <div class="form-group">
                    <label for="additionalWelcome">Additional Welcome Message</label>
                    <textarea id="additionalWelcome" name="additionalWelcome"
                        placeholder="Thank you for joining us today..." rows="3"></textarea>
                    <small>Additional information for participants</small>
                </div>

                <div class="form-group">
                    <label for="waitingMessage">Offline Message</label>
                    <input type="text" id="waitingMessage" name="waitingMessage"
                        value="Translation service is currently offline"
                        placeholder="Service is currently offline">
                    <small>Shown when translation service is not active</small>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="form-section">
                <h2>Organization Logo (Optional)</h2>

                <div class="form-group">
                    <label for="logo">Upload Logo</label>
                    <input type="file" id="logo" accept="image/*">
                    <small>Maximum size: 2MB. Recommended: 200x200px square image</small>

                    <div id="logo-preview" class="logo-preview">
                        <img id="logo-preview-img" src="" alt="Logo preview">
                        <p>Logo preview</p>
                    </div>
                </div>
            </div>

            <button type="submit" id="setup-btn" class="btn" style="width: 100%;">
                Complete Setup
            </button>
        </form>
    </div>

    <!-- Load Supabase configuration from server -->
    <script src="/register-config.js"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = window.SUPABASE_URL;
        const supabaseKey = window.SUPABASE_ANON_KEY;

        if (!supabaseUrl || !supabaseKey) {
            console.error('Supabase configuration missing');
            showError('Configuration error. Please contact administrator.');
        }

        const supabase = createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('setup-form');
        const errorDiv = document.getElementById('error-message');
        const setupBtn = document.getElementById('setup-btn');
        const logoInput = document.getElementById('logo');
        const logoPreview = document.getElementById('logo-preview');
        const logoPreviewImg = document.getElementById('logo-preview-img');

        let logoBase64 = '';

        // Language selection with max 5 limit
        const languageCheckboxes = document.querySelectorAll('input[name="translationLanguages"]');
        const languageCounter = document.getElementById('language-counter');
        const MAX_LANGUAGES = 5;

        languageCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('input[name="translationLanguages"]:checked').length;

                // Update counter
                languageCounter.textContent = `Select 1-5 languages you want to offer translation for (${checkedCount} selected)`;

                // Update counter color
                if (checkedCount === 0) {
                    languageCounter.style.color = '#dc3545'; // red
                } else if (checkedCount >= MAX_LANGUAGES) {
                    languageCounter.style.color = '#28a745'; // green
                } else {
                    languageCounter.style.color = '#666'; // gray
                }

                // Disable unchecked boxes if limit reached
                if (checkedCount >= MAX_LANGUAGES) {
                    languageCheckboxes.forEach(cb => {
                        if (!cb.checked) {
                            cb.disabled = true;
                            cb.parentElement.style.opacity = '0.5';
                        }
                    });
                } else {
                    languageCheckboxes.forEach(cb => {
                        cb.disabled = false;
                        cb.parentElement.style.opacity = '1';
                    });
                }
            });
        });

        // Check if user is verified
        async function checkVerification() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) throw error;

                if (!session || !session.user) {
                    // Not logged in, redirect to registration
                    window.location.href = '/register';
                    return;
                }

                const isVerified = session.user.email_confirmed_at !== null;
                
                if (!isVerified) {
                    // Email not verified, redirect to verification page
                    window.location.href = `/verify-email?email=${encodeURIComponent(session.user.email)}`;
                    return;
                }

                // Check if organization already set up
                const { data: churches, error: churchError } = await supabase
                    .from('churches')
                    .select('*')
                    .eq('user_id', session.user.id);

                if (!churchError && churches && churches.length > 0) {
                    // Organization already exists, redirect to control panel
                    window.location.href = '/control';
                    return;
                }

            } catch (error) {
                console.error('Verification check error:', error);
                showError('Unable to verify your account status. Please try logging in.');
            }
        }

        // Handle logo upload
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showError('Image must be less than 2MB');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onloadend = () => {
                logoBase64 = reader.result;
                logoPreviewImg.src = logoBase64;
                logoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear messages
            errorDiv.style.display = 'none';

            // Get form data
            const formData = new FormData(form);
            const churchName = formData.get('churchName').trim();
            const contactName = formData.get('contactName').trim();
            const contactPhone = formData.get('contactPhone').trim();
            const hostLanguage = formData.get('hostLanguage');
            const greeting = formData.get('greeting').trim() || 'Welcome!';
            const additionalWelcome = formData.get('additionalWelcome').trim();
            const waitingMessage = formData.get('waitingMessage').trim() || 'Service is currently offline';

            // Convert welcome messages to JSON array (one message per line)
            const welcomeMessagesText = formData.get('welcomeMessages').trim();
            const welcomeMessages = welcomeMessagesText
                ? welcomeMessagesText.split('\n').map(line => line.trim()).filter(line => line.length > 0)
                : [];

            // Get selected translation languages in proper format
            const translationLanguages = Array.from(
                document.querySelectorAll('input[name="translationLanguages"]:checked')
            ).map(cb => ({
                name: cb.dataset.name,
                locale: cb.dataset.locale
            }));

            // Validate
            if (!churchName || !contactName) {
                showError('Please fill in all required fields');
                return;
            }

            if (translationLanguages.length === 0) {
                showError('Please select at least one translation language');
                return;
            }

            if (translationLanguages.length > MAX_LANGUAGES) {
                showError(`Please select no more than ${MAX_LANGUAGES} translation languages`);
                return;
            }

            // Disable button
            setupBtn.disabled = true;
            setupBtn.textContent = 'Setting up your organization...';
            form.classList.add('loading');

            try {
                // Get current user
                const { data: { session }, error: sessionError } = await supabase.auth.getSession();

                if (sessionError) throw sessionError;
                if (!session || !session.user) {
                    throw new Error('No active session. Please log in again.');
                }

                // Call server API to create organization
                const response = await fetch('/api/register/organization', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: JSON.stringify({
                        churchName,
                        contactName,
                        contactPhone,
                        hostLanguage,
                        translationLanguages,
                        greeting,
                        message: welcomeMessages,
                        additionalWelcome,
                        waitingMessage,
                        logoBase64
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Failed to create organization');
                }

                // Success! Logout and redirect to login page
                // User needs to login again to access control panel
                await supabase.auth.signOut();
                alert('Organization setup completed successfully! Please login to access the control panel.');
                window.location.href = '/login';

            } catch (error) {
                console.error('Setup error:', error);
                showError(error.message || 'An error occurred during setup. Please try again.');
                setupBtn.disabled = false;
                setupBtn.textContent = 'Complete Setup';
                form.classList.remove('loading');
            }
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Check verification on page load
        checkVerification();
    </script>
</body>

</html>
