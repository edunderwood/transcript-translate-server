<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/css/login.css">
    <title>Register - Admin Console</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }

        .success-message {
            color: #155724;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .form-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .logo-preview {
            margin-top: 10px;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            text-align: center;
            display: none;
        }

        .logo-preview img {
            max-width: 150px;
            max-height: 150px;
        }

        small {
            color: #666;
            font-size: 12px;
        }

        .back-link {
            text-align: center;
            margin-top: 15px;
        }

        .back-link a {
            color: #007bff;
            text-decoration: none;
        }

        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body style="margin: 20px;">
    <div class="container">
        <img src="/img/logo.png" alt="Logo" class="logo">
        <h1>Open Word</h1>
        <p style="text-align: center; color: #666; margin-bottom: 20px;">Register Your Organization</p>

        <div id="error-message" class="error-message"></div>
        <div id="success-message" class="success-message"></div>

        <form id="register-form" class="validated-form" novalidate>
            <!-- Account Information -->
            <div class="form-section">
                <h2>Account Information</h2>

                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" placeholder="admin@yourchurch.org" required>
                </div>

                <div class="form-group">
                    <label for="password">Password *</label>
                    <input type="password" id="password" name="password" placeholder="Minimum 6 characters" required
                        minlength="6">
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password *</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Re-enter password"
                        required>
                </div>
            </div>

            <!-- Organization Details -->
            <div class="form-section">
                <h2>Organization Details</h2>

                <div class="form-group">
                    <label for="organizationName">Organization/Church Name *</label>
                    <input type="text" id="organizationName" name="organizationName"
                        placeholder="First Community Church" required>
                </div>

                <div class="form-group">
                    <label for="contactName">Contact Name *</label>
                    <input type="text" id="contactName" name="contactName" placeholder="John Smith" required>
                </div>

                <div class="form-group">
                    <label for="contactPhone">Contact Phone</label>
                    <input type="tel" id="contactPhone" name="contactPhone" placeholder="+1 (555) 123-4567">
                </div>
            </div>

            <!-- Language Configuration -->
            <div class="form-section">
                <h2>Language Configuration</h2>

                <div class="form-group">
                    <label for="hostLanguage">Host Language *</label>
                    <select id="hostLanguage" name="hostLanguage" required>
                        <option value="en-US">English (US)</option>
                        <option value="en-GB">English (UK)</option>
                        <option value="es-ES">Spanish (Spain)</option>
                        <option value="es-MX">Spanish (Mexico)</option>
                        <option value="fr-FR">French</option>
                        <option value="de-DE">German</option>
                        <option value="it-IT">Italian</option>
                        <option value="pt-BR">Portuguese (Brazil)</option>
                        <option value="pt-PT">Portuguese (Portugal)</option>
                    </select>
                    <small>The primary language spoken during your services</small>
                </div>

                <div class="form-group">
                    <label>Translation Languages * (Select at least one)</label>
                    <div class="checkbox-grid">
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="es"> Spanish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="fr"> French
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="de"> German
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="it"> Italian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="pt"> Portuguese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="zh"> Chinese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="ja"> Japanese
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="ko"> Korean
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="ar"> Arabic
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="hi"> Hindi
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="ru"> Russian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="pl"> Polish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="nl"> Dutch
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="sv"> Swedish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="no"> Norwegian
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="da"> Danish
                        </label>
                        <label class="checkbox-label">
                            <input type="checkbox" name="translationLanguages" value="fi"> Finnish
                        </label>
                    </div>
                    <small>Languages available for live translation</small>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="form-section">
                <h2>Organization Logo (Optional)</h2>

                <div class="form-group">
                    <label for="logo">Upload Logo</label>
                    <input type="file" id="logo" name="logo" accept="image/*">
                    <small>Maximum size: 2MB. Supported: JPG, PNG, GIF, WebP</small>

                    <div id="logo-preview" class="logo-preview">
                        <img id="logo-preview-img" src="" alt="Logo preview">
                    </div>
                </div>
            </div>

            <!-- Welcome Messages -->
            <div class="form-section">
                <h2>Welcome Messages</h2>

                <div class="form-group">
                    <label for="greeting">Main Greeting</label>
                    <input type="text" id="greeting" name="greeting" value="Welcome!"
                        placeholder="Welcome to our service">
                    <small>Displayed to participants when they join</small>
                </div>

                <div class="form-group">
                    <label for="additionalWelcome">Additional Welcome Text</label>
                    <textarea id="additionalWelcome" name="additionalWelcome" rows="3"
                        placeholder="Select your language to receive live translations..."></textarea>
                </div>

                <div class="form-group">
                    <label for="waitingMessage">Offline Message</label>
                    <input type="text" id="waitingMessage" name="waitingMessage" value="Service is currently offline"
                        placeholder="Message when service is not active">
                    <small>Shown when no translation service is active</small>
                </div>
            </div>

            <button type="submit" class="btn" id="register-btn">Create Account</button>
        </form>

        <div class="back-link">
            <p>Already have an account? <a href="/login">Sign in here</a></p>
        </div>
    </div>

    <!-- Load Supabase configuration from server -->
    <script src="/register-config.js"></script>
    
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Supabase configuration - will be injected by server
        const supabaseUrl = window.SUPABASE_URL || process.env.SUPABASE_URL;
        const supabaseKey = window.SUPABASE_ANON_KEY || process.env.SUPABASE_ANON_KEY;
        
        if (!supabaseUrl || !supabaseKey) {
            console.error('Supabase configuration missing');
            showError('Configuration error. Please contact administrator.');
        }

        const supabase = createClient(supabaseUrl, supabaseKey);

        const form = document.getElementById('register-form');
        const errorDiv = document.getElementById('error-message');
        const successDiv = document.getElementById('success-message');
        const registerBtn = document.getElementById('register-btn');
        const logoInput = document.getElementById('logo');
        const logoPreview = document.getElementById('logo-preview');
        const logoPreviewImg = document.getElementById('logo-preview-img');

        let logoBase64 = '';

        // Handle logo upload
        logoInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate
            if (!file.type.startsWith('image/')) {
                showError('Please upload an image file');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showError('Image must be less than 2MB');
                return;
            }

            // Convert to base64
            const reader = new FileReader();
            reader.onloadend = () => {
                logoBase64 = reader.result;
                logoPreviewImg.src = logoBase64;
                logoPreview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        });

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear messages
            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            // Get form data
            const formData = new FormData(form);
            const email = formData.get('email').trim();
            const password = formData.get('password');
            const confirmPassword = formData.get('confirmPassword');
            const organizationName = formData.get('organizationName').trim();
            const contactName = formData.get('contactName').trim();
            const contactPhone = formData.get('contactPhone').trim();
            const hostLanguage = formData.get('hostLanguage');
            const greeting = formData.get('greeting').trim() || 'Welcome!';
            const additionalWelcome = formData.get('additionalWelcome').trim();
            const waitingMessage = formData.get('waitingMessage').trim() || 'Service is currently offline';

            // Get selected translation languages
            const translationLanguages = Array.from(
                document.querySelectorAll('input[name="translationLanguages"]:checked')
            ).map(cb => cb.value);

            // Validate
            if (!email || !password || !organizationName || !contactName) {
                showError('Please fill in all required fields');
                return;
            }

            if (password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }

            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }

            if (translationLanguages.length === 0) {
                showError('Please select at least one translation language');
                return;
            }

            // Disable button
            registerBtn.disabled = true;
            registerBtn.textContent = 'Creating Account...';
            form.classList.add('loading');

            try {
                // Step 1: Create user account
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password
                });

                if (authError) throw authError;
                if (!authData || !authData.user) throw new Error('Failed to create user account');

                // Step 2: Create church record
                const churchKey = generateChurchKey();
                const defaultServiceId = generateServiceId();

                const churchData = {
                    user_id: authData.user.id,
                    name: organizationName,
                    church_key: churchKey,
                    greeting: greeting,
                    message: [],
                    additional_welcome: additionalWelcome,
                    waiting_message: waitingMessage,
                    logo_base64: logoBase64,
                    host_language: hostLanguage,
                    translation_languages: translationLanguages,
                    default_service_id: defaultServiceId,
                    contact_name: contactName,
                    contact_phone: contactPhone
                };

                const { data: churchResult, error: churchError } = await supabase
                    .from('churches')
                    .insert([churchData])
                    .select()
                    .single();

                if (churchError) throw churchError;

                // Step 3: Create default service
                const serviceData = {
                    church_id: churchResult.id,
                    service_id: defaultServiceId,
                    name: 'Main Service',
                    status: 'inactive',
                    active_languages: []
                };

                const { error: serviceError } = await supabase
                    .from('services')
                    .insert([serviceData]);

                if (serviceError) {
                    console.error('Service creation error:', serviceError);
                    // Don't fail registration for this
                }

                // Success!
                form.style.display = 'none';
                successDiv.innerHTML = `
                    <strong>Registration Successful!</strong><br>
                    Your account has been created. Please check your email to verify your account.<br>
                    Redirecting to login...
                `;
                successDiv.style.display = 'block';

                // Redirect after delay
                setTimeout(() => {
                    window.location.href = '/login?registered=true';
                }, 3000);

            } catch (error) {
                console.error('Registration error:', error);
                showError(error.message || 'An error occurred during registration. Please try again.');
                registerBtn.disabled = false;
                registerBtn.textContent = 'Create Account';
                form.classList.remove('loading');
            }
        });

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function generateChurchKey() {
            const random = Math.random().toString(36).substring(2, 15);
            const timestamp = Date.now().toString(36);
            return `CH_${random}${timestamp}`;
        }

        function generateServiceId() {
            const random = Math.random().toString(36).substring(2, 15);
            const timestamp = Date.now().toString(36);
            return `SVC_${random}${timestamp}`;
        }
    </script>
</body>

</html>
