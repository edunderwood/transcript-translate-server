<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/css/client.css">
    <title>Transcription Controller</title>
    <style>
        /* Responsive QR Code - Compact 150px version */
#qrcode-box h2 {
    margin-bottom: 5px;
}

#qrcode {
    display: flex !important;
    justify-content: center !important;
    align-items: center !important;
    padding: 10px !important;
    min-height: 180px !important;
}

#qrcode svg {
    width: 100%;
    height: auto;
    max-width: 150px;
    max-height: 150px;
    display: block;
    margin: 0 auto;
}

/* Responsive breakpoints */
@media (max-width: 768px) {
    #qrcode svg {
        max-width: 130px;
        max-height: 130px;
    }
    #qrcode {
        padding: 8px !important;
        min-height: 160px !important;
    }
}

@media (max-width: 480px) {
    #qrcode svg {
        max-width: 110px;
        max-height: 110px;
    }
    #qrcode {
        padding: 5px !important;
        min-height: 140px !important;
    }
}

        /* Main Header with Logo and Organisation Name - Redesigned */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px 0;
            border-bottom: 2px solid #e0e0e0;
            min-height: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .header-logo {
            height: 70px;
            width: auto;
            max-width: 200px;
            object-fit: contain;
            border-radius: 8px;
        }

        .header-organisation-name {
            font-size: 24px;
            color: #333;
            font-weight: 600;
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title {
            font-size: 20px;
            color: #333;
            font-weight: 700;
            white-space: nowrap;
        }

        /* Hamburger Menu */
        .hamburger-menu {
            position: relative;
            cursor: pointer;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            width: 35px;
            height: 35px;
            background: transparent;
            border: none;
        }

        .hamburger-menu span {
            width: 100%;
            height: 3px;
            background-color: #333;
            border-radius: 3px;
            transition: all 0.3s ease;
        }

        .hamburger-menu:hover span {
            background-color: #007bff;
        }

        /* Dropdown Menu */
        .dropdown-menu {
            position: absolute;
            top: 80px;
            right: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 220px;
            display: none;
            z-index: 1000;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-menu a,
        .dropdown-menu button {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 14px;
            color: #333;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .dropdown-menu a:hover,
        .dropdown-menu button:hover {
            background-color: #f5f5f5;
        }

        .dropdown-menu a:first-child {
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .dropdown-menu a:last-child,
        .dropdown-menu button:last-child {
            border-bottom-left-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .dropdown-divider {
            height: 1px;
            background-color: #e0e0e0;
            margin: 5px 0;
        }

        /* Dark mode support for header */
        body.dark-mode .main-header {
            border-bottom-color: #404040;
        }

        body.dark-mode .header-title,
        body.dark-mode .header-organisation-name {
            color: #e0e0e0;
        }

        body.dark-mode .hamburger-menu span {
            background-color: #e0e0e0;
        }

        body.dark-mode .dropdown-menu {
            background: #2d2d2d;
            border-color: #404040;
        }

        body.dark-mode .dropdown-menu a,
        body.dark-mode .dropdown-menu button {
            color: #e0e0e0;
        }

        body.dark-mode .dropdown-menu a:hover,
        body.dark-mode .dropdown-menu button:hover {
            background-color: #404040;
        }

        body.dark-mode .dropdown-divider {
            background-color: #404040;
        }

        /* Settings Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #666;
            line-height: 1;
            padding: 0;
            width: 30px;
            height: 30px;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }

        .language-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px 20px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }

        .language-checkboxes label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            font-size: 15px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-weight: normal;
        }

        .language-checkboxes label:hover {
            background: #e9ecef;
        }

        .language-checkboxes input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        /* Dark mode for modal */
        body.dark-mode .modal-content {
            background-color: #2d2d2d;
        }

        body.dark-mode .modal-header {
            border-bottom-color: #404040;
        }

        body.dark-mode .modal-header h2,
        body.dark-mode .form-group label {
            color: #e0e0e0;
        }

        body.dark-mode .modal-close {
            color: #b0b0b0;
        }

        body.dark-mode .modal-close:hover {
            color: #e0e0e0;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background-color: #1a1a1a;
            color: #e0e0e0;
            border-color: #404040;
        }

        body.dark-mode .language-checkboxes {
            background-color: #1a1a1a;
            border-color: #404040;
        }

        body.dark-mode .modal-footer {
            border-top-color: #404040;
        }

        /* QR Code Download Button - Header Style */
        .qrcode-download-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .qrcode-download-btn:hover {
            background-color: #357abd;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .qrcode-download-btn:active {
            background-color: #2868a8;
        }

        /* Header Controls Container */
        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* Dark Mode Toggle Switch */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            background-color: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .toggle-switch.dark {
            background-color: #4a90e2;
        }
        
        .toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background-color: white;
            border-radius: 50%;
            transition: transform 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .toggle-switch.dark .toggle-slider {
            transform: translateX(30px);
        }
        
        .theme-label {
            font-size: 14px;
            font-weight: 500;
            color: inherit;
        }
        
        /* Logout Button */
        .logout-btn {
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .logout-btn:hover {
            background-color: #c82333;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .logout-btn:active {
            transform: scale(0.98);
        }
        
        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        body.dark-mode h1,
        body.dark-mode h2,
        body.dark-mode label {
            color: #e0e0e0;
        }
        
        body.dark-mode .button-box,
        body.dark-mode .text-box-large {
            background-color: #2d2d2d;
            border-color: #404040;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        body.dark-mode input,
        body.dark-mode select,
        body.dark-mode button:not(.logout-btn):not(.toggle-switch) {
            background-color: #3a3a3a;
            color: #e0e0e0;
            border-color: #555;
        }
        
        body.dark-mode input:focus,
        body.dark-mode select:focus {
            border-color: #4a90e2;
            outline: none;
        }
        
        /* Fix for dropdowns in dark mode */
        body.dark-mode select option {
            background-color: #3a3a3a;
            color: #e0e0e0;
        }
        
        body.dark-mode .drop-down-selector {
            background-color: #3a3a3a !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
        }
        
        body.dark-mode #audioInputSelect {
            background-color: #3a3a3a !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
        }
        
        body.dark-mode #langInputSelect {
            background-color: #3a3a3a !important;
            color: #e0e0e0 !important;
            border: 1px solid #555 !important;
        }
        
        /* Fix for Start Streaming button in dark mode */
        body.dark-mode .start-action {
            background-color: #28a745 !important;
            color: white !important;
            border: none;
        }
        
        body.dark-mode .start-action:hover {
            background-color: #218838 !important;
        }
        
        body.dark-mode #enableStreaming {
            background-color: #28a745 !important;
            color: white !important;
        }
        
        body.dark-mode #enableStreaming:hover {
            background-color: #218838 !important;
        }
        
        body.dark-mode .stop-action {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        body.dark-mode .stop-action:hover {
            background-color: #c82333 !important;
        }
        
        body.dark-mode #disableStreaming {
            background-color: #dc3545 !important;
            color: white !important;
        }
        
        body.dark-mode #disableStreaming:hover {
            background-color: #c82333 !important;
        }
        
        body.dark-mode .recording-status {
            background-color: #2d2d2d;
            border-color: #404040;
        }
        
        body.dark-mode .recording-status #recording-text {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .status-light {
            border-color: #404040 !important;
        }
        
        /* Keep recording light red in both modes */
        body.dark-mode #recording-light {
            background-color: #dc3545 !important;
        }
        
        body.dark-mode #transcript li,
        body.dark-mode #dynamic-monitor-list li {
            color: #e0e0e0 !important;
            border-bottom-color: #404040;
        }
        
        /* Fix transcript text visibility */
        body.dark-mode #transcript {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #transcript li {
            color: #e0e0e0 !important;
            background-color: #2d2d2d !important;
            border-bottom-color: #404040 !important;
        }
        
        /* Override alternating row colors in dark mode */
        body.dark-mode #transcript > li:nth-child(odd) {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #transcript > li:nth-child(even) {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #transcript-text-box {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode #transcript-text-box h2 {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .text-box-large {
            background-color: #2d2d2d !important;
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .text-box-large h2 {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .text-box-large ul {
            color: #e0e0e0 !important;
        }
        
        body.dark-mode .text-box-large ul li {
            color: #e0e0e0 !important;
            background-color: #2d2d2d !important;
        }
        
        /* Transcript Box - Improved Sizing */
        #transcript-text-box {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        #transcript {
            max-height: 350px;
            overflow-y: auto;
        }

        /* Smooth transition for theme switch */
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .button-box,
        .text-box-large,
        input,
        select,
        button {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>

<body style="margin: 30px;">
    <!-- Redesigned Header -->
    <div class="main-header">
        <div class="header-left">
            <img id="headerLogo" class="header-logo" src="" alt="Logo" style="display: none;" />
            <h1 id="headerOrganisationName" class="header-organisation-name"></h1>
        </div>
        <div class="header-right">
            <span class="header-title"><strong>Open Word</strong> v1.1</span>
            <button class="hamburger-menu" id="hamburgerMenu" aria-label="Menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </div>

    <!-- Dropdown Menu -->
    <div class="dropdown-menu" id="dropdownMenu">
        <button id="darkModeMenuItem">
            <span id="darkModeIcon">🌙</span>
            <span id="darkModeText">Dark Mode</span>
        </button>
        <div class="dropdown-divider"></div>
        <button id="saveTranscriptMenuItem">
            <span>💾</span>
            <span>Save Transcript</span>
        </button>
        <div class="dropdown-divider"></div>
        <button id="clearTranscriptMenuItem">
            <span>🗑️</span>
            <span>Clear Transcript</span>
        </button>
        <div class="dropdown-divider"></div>
        <button id="downloadQRMenuItem">
            <span>📥</span>
            <span>Export QR Code</span>
        </button>
        <div class="dropdown-divider"></div>
        <button id="settingsMenuItem">
            <span>🏢</span>
            <span>Organisation Settings</span>
        </button>
        <button id="clientSettingsMenuItem">
            <span>📱</span>
            <span>Client Settings</span>
        </button>
        <div class="dropdown-divider"></div>
        <button id="logoutMenuItem">
            <span>🚪</span>
            <span>Logout</span>
        </button>
    </div>

    <!-- Organisation Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Organisation Settings</h2>
                <button class="modal-close" id="closeSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="settingsForm">
                    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">Organization Details</h3>

                    <div class="form-group">
                        <label for="settingsOrganisationName">Organisation Name</label>
                        <input type="text" id="settingsOrganisationName" required>
                    </div>

                    <div class="form-group">
                        <label for="settingsContactName">Contact Name</label>
                        <input type="text" id="settingsContactName" required>
                    </div>

                    <div class="form-group">
                        <label for="settingsContactPhone">Contact Phone</label>
                        <input type="tel" id="settingsContactPhone">
                    </div>

                    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">

                    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">Pricing Configuration</h3>

                    <div class="form-group">
                        <label for="settingsMonthlyFee">Monthly Fixed Fee (£)</label>
                        <input type="number" id="settingsMonthlyFee" step="0.01" min="0" placeholder="0.00">
                        <small>Fixed monthly charge for this organisation (in GBP)</small>
                    </div>

                    <div class="form-group">
                        <label for="settingsPricePerCharacter">Price Per Character (£)</label>
                        <input type="number" id="settingsPricePerCharacter" step="0.00000001" min="0" placeholder="0.00002">
                        <small>Cost per translated character (Default: £0.00002 = £20 per million characters)</small>
                    </div>

                    <div class="form-group">
                        <label>Price Per Million Characters</label>
                        <input type="text" id="settingsPricePerMillion" readonly style="background-color: #f3f4f6; cursor: not-allowed;">
                        <small>Calculated automatically from price per character</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelSettings">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveSettings">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Client Settings Modal -->
    <div class="modal" id="clientSettingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Client Appearance Settings</h2>
                <button class="modal-close" id="closeClientSettingsModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="clientSettingsForm">
                    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">Language Configuration</h3>

                    <div class="form-group">
                        <label for="settingsHostLanguage">Host Language</label>
                        <select id="settingsHostLanguage" required>
                            <option value="en-GB">English (UK)</option>
                            <option value="en-US">English (US)</option>
                            <option value="es-ES">Spanish</option>
                            <option value="fr-FR">French</option>
                            <option value="de-DE">German</option>
                        </select>
                        <small>The primary language spoken during your services</small>
                    </div>

                    <div class="form-group">
                        <label>Translation Languages (Max 5)</label>
                        <div class="language-checkboxes" id="settingsLanguageCheckboxes">
                            <!-- Will be populated dynamically -->
                        </div>
                        <small id="settingsLanguageCounter">0 selected</small>
                    </div>

                    <hr style="margin: 24px 0; border: none; border-top: 1px solid #e5e7eb;">

                    <h3 style="margin-top: 0; margin-bottom: 16px; font-size: 16px;">Welcome Messages</h3>

                    <div class="form-group">
                        <label for="settingsGreeting">Greeting Text</label>
                        <input type="text" id="settingsGreeting">
                        <small>Shown at the top of the participant app</small>
                    </div>

                    <div class="form-group">
                        <label for="settingsMessages">Welcome Messages</label>
                        <textarea id="settingsMessages" rows="4" placeholder="Enter each message on a new line"></textarea>
                        <small>Enter each message on a separate line. These appear as bullet points below the greeting.</small>
                    </div>

                    <div class="form-group">
                        <label for="settingsAdditionalWelcome">Additional Welcome Message</label>
                        <textarea id="settingsAdditionalWelcome" rows="3"></textarea>
                        <small>Additional information for participants</small>
                    </div>

                    <div class="form-group">
                        <label for="settingsWaitingMessage">Offline Message</label>
                        <input type="text" id="settingsWaitingMessage">
                        <small>Shown when translation service is not active</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="cancelClientSettings">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveClientSettings">Save Changes</button>
            </div>
        </div>
    </div>

    <div class="button-container">
        <div class="button-box fixed-box-small" style="flex: 0 0 180px;">
            <h2 style="margin-top: 0;">Service ID</h2>
            <p id="serviceId"></p>
            <div style="margin-top: 15px;">
                <label for="key">Organisation Key</label>
                <input type="text" id="key" name="key" maxlength="15" size="15" style="width: 100%; margin-top: 5px; font-family: monospace; font-size: 13px;" readonly />
            </div>
        </div>
        <div class="button-box fixed-box-medium" id="qrcode-box">
            <h2 style="margin-bottom: 5px;">QR Code</h2>
            <div id="qrcode" style="display: flex; justify-content: center; align-items: center; padding: 5px 10px; min-height: 180px;"></div>
        </div>
        <div class="button-box fixed-box-large" style="padding-top: 10px;">
            <h2 style="margin-top: 0; margin-bottom: 10px;">Main Control</h2>
            <form id="audioForm">
                <button type="submit" class="start-action" id="enableStreaming">Start Streaming</button>
            </form>
            <button class="stop-action" id="disableStreaming" style="display: none;">Stop Streaming</button>
            <div class="recording-status" id="recording-status" style="margin-top: 15px;">
                <span id="recording-light" class="status-light recording"></span>
                <span id="recording-text">Streaming in progress</span>
            </div>
        </div>
        <div class="button-box">
            <h2>Language</h2>
            <label for="langInputSelect">Select the source language :</label>
            <select id="langInputSelect" class="drop-down-selector"></select>
        </div>
        <div class="button-box">
            <h2>Audio Select</h2>
            <label for="audioInputSelect">Select an audio input device:</label>
            <select id="audioInputSelect" class="drop-down-selector"></select>
        </div>
        <div class="button-box" style="display: none;">
            <h2>ProPresenter</h2>
            <label for="host">Host</label>
            <input id="host" name="host" />
            <label for="port">Port</label>
            <input id="port" name="port" />
            <input type="checkbox" id="propresenterCheckbox" name="Display in ProPropresenter"
                value="propresenterValue">
            <label for="finalCheckbox">Display in ProPresenter</label>
        </div>
        <!-- For now hide the options box until we have it working -->
        <div class="button-box" style="display: none;">
            <h2>Options</h2>
            <input type="checkbox" id="interimCheckbox" name="Show Interim" value="interimValue">
            <label for="finalCheckbox">Interim Results</label>
        </div>
        <div class="button-box left-box" id="subscriber-box">
            <h2>Subscribers</h2>
            <ul id="dynamic-monitor-list"></ul>
        </div>
        <div class="button-box left-box" id="usage-box">
            <h2>Translation Usage</h2>
            <div id="usage-period" style="margin-bottom: 10px;">
                <select id="usage-period-select" style="padding: 5px; border-radius: 4px;">
                    <option value="week">Last 7 Days</option>
                    <option value="month" selected>This Month</option>
                    <option value="90">Last 90 Days</option>
                </select>
            </div>
            <div id="usage-stats" style="font-size: 14px;">
                <p><strong>Total Characters:</strong> <span id="usage-total">-</span></p>
                <p><strong>Client Sessions:</strong> <span id="usage-sessions">-</span></p>
                <p><strong>Estimated Cost:</strong> <span id="usage-cost">£0.00</span></p>
                <div id="usage-by-language" style="margin-top: 10px;">
                    <p style="font-weight: 600; margin-bottom: 5px;">By Language:</p>
                    <ul id="usage-language-list" style="list-style: none; padding-left: 0;"></ul>
                </div>
            </div>
        </div>
    </div>

    <div class="text-box-large" id="transcript-text-box">
        <h2>Transcript</h2>
        <ul id="transcript"></ul>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/js/common.js"></script>
    <script src="/js/control.js"></script>
    
    <!-- Hamburger Menu, Dark Mode, Settings & Logout functionality -->
    <script>
        // ============================================================
        // HAMBURGER MENU
        // ============================================================
        const hamburgerMenu = document.getElementById('hamburgerMenu');
        const dropdownMenu = document.getElementById('dropdownMenu');

        // Toggle dropdown menu
        hamburgerMenu.addEventListener('click', function(e) {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!dropdownMenu.contains(e.target) && !hamburgerMenu.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        // ============================================================
        // DARK MODE TOGGLE
        // ============================================================
        const body = document.body;
        const darkModeMenuItem = document.getElementById('darkModeMenuItem');
        const darkModeIcon = document.getElementById('darkModeIcon');
        const darkModeText = document.getElementById('darkModeText');

        // Check for saved theme preference or default to light mode
        const currentTheme = localStorage.getItem('theme') || 'light';

        // Apply saved theme on load
        if (currentTheme === 'dark') {
            body.classList.add('dark-mode');
            darkModeIcon.textContent = '☀️';
            darkModeText.textContent = 'Light Mode';
        }

        // Toggle theme on click
        darkModeMenuItem.addEventListener('click', function() {
            body.classList.toggle('dark-mode');

            if (body.classList.contains('dark-mode')) {
                darkModeIcon.textContent = '☀️';
                darkModeText.textContent = 'Light Mode';
                localStorage.setItem('theme', 'dark');
            } else {
                darkModeIcon.textContent = '🌙';
                darkModeText.textContent = 'Dark Mode';
                localStorage.setItem('theme', 'light');
            }

            dropdownMenu.classList.remove('show');
        });

        // ============================================================
        // QR CODE DOWNLOAD
        // ============================================================
        document.getElementById('downloadQRMenuItem').addEventListener('click', function() {
            downloadQRCode();
            dropdownMenu.classList.remove('show');
        });

        // ============================================================
        // LOGOUT FUNCTIONALITY
        // ============================================================
        document.getElementById('logoutMenuItem').addEventListener('click', function() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear the Organisation Key before logout
                document.getElementById('key').value = '';

                // Clear access token
                localStorage.removeItem('access_token');

                window.location.href = '/login';
            }
            dropdownMenu.classList.remove('show');
        });

        // ============================================================
        // SETTINGS MODAL FUNCTIONALITY
        // ============================================================
        const settingsModal = document.getElementById('settingsModal');
        const settingsMenuItem = document.getElementById('settingsMenuItem');
        const closeSettingsModal = document.getElementById('closeSettingsModal');
        const cancelSettings = document.getElementById('cancelSettings');
        const saveSettings = document.getElementById('saveSettings');
        const settingsForm = document.getElementById('settingsForm');

        // Language list for settings
        const AVAILABLE_LANGUAGES = [
            {"name": "Arabic", "locale": "ar-001"},
            {"name": "Bengali", "locale": "bn-BD"},
            {"name": "Chinese (Simplified)", "locale": "zh-CN"},
            {"name": "Chinese (Traditional)", "locale": "zh-TW"},
            {"name": "Dutch", "locale": "nl-NL"},
            {"name": "English", "locale": "en-US"},
            {"name": "English (UK)", "locale": "en-GB"},
            {"name": "Filipino", "locale": "tl-PH"},
            {"name": "French", "locale": "fr-FR"},
            {"name": "German", "locale": "de-DE"},
            {"name": "Greek", "locale": "el-GR"},
            {"name": "Hebrew", "locale": "he-IL"},
            {"name": "Hindi", "locale": "hi-IN"},
            {"name": "Indonesian", "locale": "id-ID"},
            {"name": "Italian", "locale": "it-IT"},
            {"name": "Japanese", "locale": "ja-JP"},
            {"name": "Korean", "locale": "ko-KR"},
            {"name": "Persian", "locale": "fa-IR"},
            {"name": "Polish", "locale": "pl-PL"},
            {"name": "Portuguese", "locale": "pt-PT"},
            {"name": "Portuguese (Brazil)", "locale": "pt-BR"},
            {"name": "Russian", "locale": "ru-RU"},
            {"name": "Spanish", "locale": "es-ES"},
            {"name": "Spanish (Latin America)", "locale": "es-419"},
            {"name": "Spanish (Mexico)", "locale": "es-MX"},
            {"name": "Swahili", "locale": "sw-KE"},
            {"name": "Thai", "locale": "th-TH"},
            {"name": "Turkish", "locale": "tr-TR"},
            {"name": "Ukrainian", "locale": "uk-UA"},
            {"name": "Urdu", "locale": "ur-PK"},
            {"name": "Vietnamese", "locale": "vi-VN"}
        ];

        // Open settings modal
        settingsMenuItem.addEventListener('click', function() {
            loadSettings();
            settingsModal.classList.add('show');
            dropdownMenu.classList.remove('show');
        });

        // Close modal handlers
        closeSettingsModal.addEventListener('click', function() {
            settingsModal.classList.remove('show');
        });

        cancelSettings.addEventListener('click', function() {
            settingsModal.classList.remove('show');
        });

        // Close modal when clicking outside
        settingsModal.addEventListener('click', function(e) {
            if (e.target === settingsModal) {
                settingsModal.classList.remove('show');
            }
        });

        // Update price per million when price per character changes
        document.getElementById('settingsPricePerCharacter').addEventListener('input', function(e) {
            const pricePerChar = parseFloat(e.target.value) || 0;
            const pricePerMillion = (pricePerChar * 1000000).toFixed(2);
            document.getElementById('settingsPricePerMillion').value = '£' + pricePerMillion;
        });

        // Load current settings into modal
        async function loadSettings() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/api/organisation/profile', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const result = await response.json();

                if (result.success && result.data) {
                    const organisation = result.data;
                    document.getElementById('settingsOrganisationName').value = organisation.name || '';
                    document.getElementById('settingsContactName').value = organisation.contact_name || '';
                    document.getElementById('settingsContactPhone').value = organisation.contact_phone || '';
                    document.getElementById('settingsHostLanguage').value = organisation.host_language || 'en-GB';
                    document.getElementById('settingsGreeting').value = organisation.greeting || '';

                    // Convert message array to newline-separated text
                    const messages = organisation.message || [];
                    document.getElementById('settingsMessages').value = Array.isArray(messages) ? messages.join('\n') : '';

                    document.getElementById('settingsAdditionalWelcome').value = organisation.additional_welcome || '';
                    document.getElementById('settingsWaitingMessage').value = organisation.waiting_message || '';

                    // Load pricing fields
                    const monthlyFee = parseFloat(organisation.monthly_fee_gbp) || 0.00;
                    const pricePerChar = parseFloat(organisation.price_per_character_gbp) || 0.00002;
                    document.getElementById('settingsMonthlyFee').value = monthlyFee.toFixed(2);
                    document.getElementById('settingsPricePerCharacter').value = pricePerChar.toFixed(8);
                    document.getElementById('settingsPricePerMillion').value = '£' + (pricePerChar * 1000000).toFixed(2);

                    // Populate language checkboxes
                    populateLanguageCheckboxes(organisation.translation_languages || []);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
                alert('Failed to load settings. Please try again.');
            }
        }

        // Populate language checkboxes
        function populateLanguageCheckboxes(selectedLanguages) {
            const container = document.getElementById('settingsLanguageCheckboxes');
            const counter = document.getElementById('settingsLanguageCounter');
            container.innerHTML = '';

            const selectedLocales = selectedLanguages.map(lang => lang.locale);

            AVAILABLE_LANGUAGES.forEach(lang => {
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                const span = document.createElement('span');

                span.textContent = lang.name;

                checkbox.type = 'checkbox';
                checkbox.value = lang.locale;
                checkbox.dataset.name = lang.name;
                checkbox.dataset.locale = lang.locale;

                if (selectedLocales.includes(lang.locale)) {
                    checkbox.checked = true;
                }

                // Add change listener for 5 language limit
                checkbox.addEventListener('change', function() {
                    const checkedCount = container.querySelectorAll('input:checked').length;
                    counter.textContent = `${checkedCount} selected`;

                    if (checkedCount >= 5) {
                        container.querySelectorAll('input:not(:checked)').forEach(cb => {
                            cb.disabled = true;
                            cb.parentElement.style.opacity = '0.5';
                        });
                    } else {
                        container.querySelectorAll('input').forEach(cb => {
                            cb.disabled = false;
                            cb.parentElement.style.opacity = '1';
                        });
                    }
                });

                label.appendChild(span);
                label.appendChild(checkbox);
                container.appendChild(label);
            });

            // Update initial counter
            const checkedCount = selectedLocales.length;
            counter.textContent = `${checkedCount} selected`;
        }

        // Save organisation settings
        saveSettings.addEventListener('click', async function() {
            try {
                const settingsData = {
                    name: document.getElementById('settingsOrganisationName').value,
                    contact_name: document.getElementById('settingsContactName').value,
                    contact_phone: document.getElementById('settingsContactPhone').value,
                    monthly_fee_gbp: parseFloat(document.getElementById('settingsMonthlyFee').value) || 0.00,
                    price_per_character_gbp: parseFloat(document.getElementById('settingsPricePerCharacter').value) || 0.00002
                };

                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/api/organisation/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(settingsData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Organisation settings saved successfully!');
                    settingsModal.classList.remove('show');
                    // Reload page to reflect changes
                    location.reload();
                } else {
                    throw new Error(result.message || 'Failed to save settings');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                alert('Failed to save settings: ' + error.message);
            }
        });

        // ============================================================
        // CLIENT SETTINGS MODAL FUNCTIONALITY
        // ============================================================
        const clientSettingsModal = document.getElementById('clientSettingsModal');
        const clientSettingsMenuItem = document.getElementById('clientSettingsMenuItem');
        const closeClientSettingsModal = document.getElementById('closeClientSettingsModal');
        const cancelClientSettings = document.getElementById('cancelClientSettings');
        const saveClientSettings = document.getElementById('saveClientSettings');
        const clientSettingsForm = document.getElementById('clientSettingsForm');

        // Open client settings modal
        clientSettingsMenuItem.addEventListener('click', function() {
            loadClientSettings();
            clientSettingsModal.classList.add('show');
            dropdownMenu.classList.remove('show');
        });

        // Close modal handlers
        closeClientSettingsModal.addEventListener('click', function() {
            clientSettingsModal.classList.remove('show');
        });

        cancelClientSettings.addEventListener('click', function() {
            clientSettingsModal.classList.remove('show');
        });

        // Close modal when clicking outside
        clientSettingsModal.addEventListener('click', function(e) {
            if (e.target === clientSettingsModal) {
                clientSettingsModal.classList.remove('show');
            }
        });

        // Load client settings
        async function loadClientSettings() {
            try {
                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/api/organisation/profile', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const result = await response.json();

                if (result.success && result.data) {
                    const organisation = result.data;
                    document.getElementById('settingsHostLanguage').value = organisation.host_language || 'en-GB';
                    document.getElementById('settingsGreeting').value = organisation.greeting || '';

                    // Convert message array to newline-separated text
                    const messages = organisation.message || [];
                    document.getElementById('settingsMessages').value = Array.isArray(messages) ? messages.join('\n') : '';

                    document.getElementById('settingsAdditionalWelcome').value = organisation.additional_welcome || '';
                    document.getElementById('settingsWaitingMessage').value = organisation.waiting_message || '';

                    // Populate language checkboxes
                    populateLanguageCheckboxes(organisation.translation_languages || []);
                }
            } catch (error) {
                console.error('Error loading client settings:', error);
                alert('Failed to load client settings. Please try again.');
            }
        }

        // Save client settings
        saveClientSettings.addEventListener('click', async function() {
            try {
                const container = document.getElementById('settingsLanguageCheckboxes');
                const checkedBoxes = container.querySelectorAll('input:checked');

                if (checkedBoxes.length === 0) {
                    alert('Please select at least one translation language.');
                    return;
                }

                if (checkedBoxes.length > 5) {
                    alert('Please select no more than 5 translation languages.');
                    return;
                }

                const translationLanguages = Array.from(checkedBoxes).map(cb => ({
                    name: cb.dataset.name,
                    locale: cb.dataset.locale
                }));

                // Convert welcome messages to JSON array
                const messagesText = document.getElementById('settingsMessages').value.trim();
                const welcomeMessages = messagesText
                    ? messagesText.split('\n').map(line => line.trim()).filter(line => line.length > 0)
                    : [];

                const clientSettingsData = {
                    host_language: document.getElementById('settingsHostLanguage').value,
                    translation_languages: translationLanguages,
                    greeting: document.getElementById('settingsGreeting').value,
                    message: welcomeMessages,
                    additional_welcome: document.getElementById('settingsAdditionalWelcome').value,
                    waiting_message: document.getElementById('settingsWaitingMessage').value
                };

                const accessToken = localStorage.getItem('access_token');
                const response = await fetch('/api/organisation/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify(clientSettingsData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('Client settings saved successfully!');
                    clientSettingsModal.classList.remove('show');
                    // Reload page to reflect changes
                    location.reload();
                } else {
                    throw new Error(result.message || 'Failed to save client settings');
                }
            } catch (error) {
                console.error('Error saving client settings:', error);
                alert('Failed to save client settings: ' + error.message);
            }
        });

        // Clear Organisation Key when page is about to unload (browser close, refresh, navigate away)
        window.addEventListener('beforeunload', function() {
            document.getElementById('key').value = '';
        });

        // Clear Organisation Key when page loses visibility (tab switch, minimize)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Optional: only clear if you want to clear on tab switch
                // Uncomment the line below if you want this behavior
                // document.getElementById('key').value = '';
            }
        });
        
        // Save Transcript Functionality
        async function saveTranscript() {
            const transcriptList = document.getElementById('transcript');
            const transcriptItems = transcriptList.querySelectorAll('li');

            if (transcriptItems.length === 0) {
                alert('No transcript to save!');
                return;
            }

            // Collect transcript text
            let transcriptText = 'Transcript\n';
            transcriptText += '='.repeat(50) + '\n';
            transcriptText += 'Date: ' + new Date().toLocaleString() + '\n';
            transcriptText += '='.repeat(50) + '\n\n';

            transcriptItems.forEach((item, index) => {
                transcriptText += `${index + 1}. ${item.textContent}\n`;
            });

            const blob = new Blob([transcriptText], { type: 'text/plain' });
            const defaultFilename = `transcript_${new Date().toISOString().slice(0,10)}_${Date.now()}.txt`;

            // Try to use File System Access API for save dialog
            if ('showSaveFilePicker' in window) {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: defaultFilename,
                        types: [{
                            description: 'Text File',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });

                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();

                    alert('Transcript saved successfully!');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error saving file:', err);
                    }
                    // User cancelled or error - fall through to download method
                }
            }

            // Fallback: Traditional download
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = defaultFilename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            alert('Transcript saved successfully!');
        }
        
        // Attach save functionality to menu item
        document.getElementById('saveTranscriptMenuItem').addEventListener('click', saveTranscript);
        
        // Download QR Code Functionality
        async function downloadQRCode() {
            const qrcodeBox = document.getElementById('qrcode');
            const svgElement = qrcodeBox.querySelector('svg');
            
            if (!svgElement) {
                alert('No QR code to download! Please wait for the QR code to load.');
                return;
            }
            
            // Try Method 1: Client-side SVG to PNG conversion
            try {
                await downloadQRCodeClientSide(svgElement);
            } catch (error) {
                console.error('Client-side conversion failed:', error);
                // Fallback to Method 2: Server-side PNG generation
                try {
                    await downloadQRCodeServerSide();
                } catch (serverError) {
                    console.error('Server-side generation failed:', serverError);
                    alert('Failed to download QR code. Please try again.');
                }
            }
        }
        
        // Method 1: Client-side SVG to PNG conversion
        async function downloadQRCodeClientSide(svgElement) {
            return new Promise((resolve, reject) => {
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                // Set canvas size (increase for better quality)
                const scale = 4;
                const size = 512 * scale;
                canvas.width = size;
                canvas.height = size;

                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);

                img.onload = async function() {
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, size, size);
                    ctx.drawImage(img, 0, 0, size, size);

                    canvas.toBlob(async function(blob) {
                        if (!blob) {
                            reject(new Error('Failed to create blob'));
                            return;
                        }

                        const defaultFilename = `qrcode_service_${Date.now()}.png`;

                        // Try to use File System Access API for save dialog
                        if ('showSaveFilePicker' in window) {
                            try {
                                const handle = await window.showSaveFilePicker({
                                    suggestedName: defaultFilename,
                                    types: [{
                                        description: 'PNG Image',
                                        accept: { 'image/png': ['.png'] }
                                    }]
                                });

                                const writable = await handle.createWritable();
                                await writable.write(blob);
                                await writable.close();

                                URL.revokeObjectURL(url);
                                resolve();
                                return;
                            } catch (err) {
                                if (err.name !== 'AbortError') {
                                    console.error('Error saving file:', err);
                                }
                                // User cancelled or error - fall through to download method
                            }
                        }

                        // Fallback: Traditional download
                        const downloadUrl = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = downloadUrl;
                        a.download = defaultFilename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(downloadUrl);
                        URL.revokeObjectURL(url);
                        
                        alert('QR code downloaded successfully!');
                        resolve();
                    }, 'image/png');
                };
                
                img.onerror = function() {
                    URL.revokeObjectURL(url);
                    reject(new Error('Failed to load SVG'));
                };
                
                img.src = url;
            });
        }
        
        // Method 2: Server-side PNG generation (fallback)
        async function downloadQRCodeServerSide() {
            // Get the service code from the page
            const serviceIdInput = document.getElementById('serviceId');
            if (!serviceIdInput || !serviceIdInput.value) {
                throw new Error('Service ID not found');
            }
            
            const serviceId = serviceIdInput.value;
            
            // Request PNG QR code from server
            const response = await fetch('/qrcode/generate', {
                method: 'POST',
                body: JSON.stringify({ serviceId, format: 'png' }),
                headers: { 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) {
                throw new Error('Failed to generate QR code on server');
            }
            
            const data = await response.json();
            
            if (!data.success || !data.responseObject.qrCode) {
                throw new Error('Invalid server response');
            }
            
            // data.responseObject.qrCode is a data URL, download it directly
            const a = document.createElement('a');
            a.href = data.responseObject.qrCode;
            a.download = `qrcode_service_${Date.now()}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert('QR code downloaded successfully!');
        }

        // Clear Transcript Functionality
        function clearTranscript() {
            if (confirm('Are you sure you want to clear the transcript? This cannot be undone.')) {
                const transcriptList = document.getElementById('transcript');
                transcriptList.innerHTML = '';
                alert('Transcript cleared!');
            }
        }
        
        // Attach clear functionality to menu item
        document.getElementById('clearTranscriptMenuItem').addEventListener('click', clearTranscript);

        // ============================================================
        // TRANSLATION USAGE STATISTICS
        // ============================================================
        async function fetchUsageStats(period = 'month') {
            try {
                console.log('📊 Fetching usage stats for period:', period);
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    console.warn('⚠️  No access token available for usage stats');
                    document.getElementById('usage-total').textContent = 'Not logged in';
                    return;
                }

                const url = `/api/organisation/usage?period=${period}`;
                console.log('🔗 Fetching from:', url);

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                console.log('📡 Response status:', response.status);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ API Error:', response.status, errorText);
                    throw new Error(`Failed to fetch usage stats: ${response.status}`);
                }

                const result = await response.json();
                console.log('✅ Usage data received:', result);

                if (result.success && result.data) {
                    console.log('📈 Displaying usage stats');
                    displayUsageStats(result.data);
                } else {
                    console.warn('⚠️  No usage data in response:', result);
                    document.getElementById('usage-total').textContent = '0';
                    document.getElementById('usage-cost').textContent = '0.00';
                }
            } catch (error) {
                console.error('❌ Error fetching usage stats:', error);
                document.getElementById('usage-total').textContent = 'Error loading';
                document.getElementById('usage-cost').textContent = '0.00';
            }
        }

        function displayUsageStats(data) {
            console.log('📊 displayUsageStats called with data:', data);
            console.log('   Total Characters:', data.totalCharacters);
            console.log('   Total Client Sessions:', data.totalClientSessions);
            console.log('   Estimated Cost:', data.estimatedCost);
            console.log('   By Language:', data.byLanguage);

            // Display total characters with formatting
            const totalFormatted = data.totalCharacters.toLocaleString();
            document.getElementById('usage-total').textContent = totalFormatted;
            console.log('   Displayed total:', totalFormatted);

            // Display total client sessions
            const sessionsFormatted = (data.totalClientSessions || 0).toLocaleString();
            document.getElementById('usage-sessions').textContent = sessionsFormatted;
            console.log('   Displayed sessions:', sessionsFormatted);

            // Display estimated cost with currency symbol
            const currencySymbol = data.currencySymbol || '£';
            document.getElementById('usage-cost').textContent = currencySymbol + data.estimatedCost;
            console.log('   Displayed cost:', currencySymbol + data.estimatedCost);

            // Display by language
            const languageList = document.getElementById('usage-language-list');
            languageList.innerHTML = '';

            if (data.byLanguage && Object.keys(data.byLanguage).length > 0) {
                console.log('   Languages found:', Object.keys(data.byLanguage).length);
                // Sort languages by character count (descending)
                const sortedLanguages = Object.entries(data.byLanguage)
                    .sort((a, b) => {
                        const aChars = typeof b[1] === 'object' ? b[1].characters : b[1];
                        const bChars = typeof a[1] === 'object' ? a[1].characters : a[1];
                        return aChars - bChars;
                    });

                sortedLanguages.forEach(([lang, stats]) => {
                    const li = document.createElement('li');
                    li.style.marginBottom = '3px';

                    // Check if stats is an object (new format) or number (old format)
                    if (typeof stats === 'object' && stats.characters !== undefined) {
                        li.innerHTML = `<span style="display: inline-block; width: 60px;">${lang}:</span> ${stats.characters.toLocaleString()} chars, ${stats.sessions} sessions (max ${stats.maxClients} concurrent)`;
                        console.log(`   Added language: ${lang} = ${stats.characters} chars, ${stats.sessions} sessions`);
                    } else {
                        // Fallback for old format
                        li.innerHTML = `<span style="display: inline-block; width: 60px;">${lang}:</span> ${stats.toLocaleString()}`;
                        console.log(`   Added language: ${lang} = ${stats}`);
                    }
                    languageList.appendChild(li);
                });
            } else {
                console.log('   No language data available');
                const li = document.createElement('li');
                li.textContent = 'No usage data yet';
                li.style.color = '#666';
                languageList.appendChild(li);
            }
        }

        // Period selector change handler
        document.getElementById('usage-period-select').addEventListener('change', function(e) {
            fetchUsageStats(e.target.value);
        });

        // Fetch usage stats on page load (after a short delay to ensure auth is loaded)
        setTimeout(() => {
            fetchUsageStats('month');
        }, 1000);

        // Refresh usage stats every 60 seconds
        setInterval(() => {
            const period = document.getElementById('usage-period-select').value;
            fetchUsageStats(period);
        }, 60000);
    </script>
</body>

</html>
