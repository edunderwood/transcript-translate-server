<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="/css/login.css">
    <title>Verify Email - Open Word</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .info-box {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .success-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }

        .warning-box {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .email-display {
            font-weight: bold;
            color: #007bff;
            font-size: 18px;
            margin: 10px 0;
        }

        .btn-secondary {
            background-color: #6c757d;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 30px;
            gap: 10px;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #28a745;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.active .step-number {
            background-color: #007bff;
        }

        .step.inactive .step-number {
            background-color: #ccc;
        }

        .step-label {
            font-size: 14px;
            color: #333;
        }

        .step-divider {
            width: 40px;
            height: 2px;
            background-color: #ccc;
        }

        .checkmark {
            font-size: 16px;
        }

        .instructions {
            text-align: left;
            margin: 20px 0;
        }

        .instructions ol {
            padding-left: 20px;
        }

        .instructions li {
            margin: 10px 0;
            color: #333;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body style="margin: 20px;">
    <div class="container">
        <img src="/img/logo.png" alt="Logo" class="logo">
        <h1>Open Word</h1>

        <!-- Step Indicator -->
        <div class="step-indicator">
            <div class="step">
                <div class="step-number">‚úì</div>
                <span class="step-label">Account</span>
            </div>
            <div class="step-divider"></div>
            <div class="step active">
                <div class="step-number">2</div>
                <span class="step-label">Verify Email</span>
            </div>
            <div class="step-divider"></div>
            <div class="step inactive">
                <div class="step-number">3</div>
                <span class="step-label">Organization</span>
            </div>
        </div>

        <!-- Verification Pending -->
        <div id="pending-box" class="info-box">
            <div class="icon">üìß</div>
            <h2>Check Your Email</h2>
            <p>We've sent a verification email to:</p>
            <div class="email-display" id="user-email"></div>
            
            <div class="instructions">
                <p><strong>Next steps:</strong></p>
                <ol>
                    <li>Check your inbox (and spam folder)</li>
                    <li>Click the verification link in the email</li>
                    <li>You'll be redirected back here to continue</li>
                </ol>
            </div>

            <button id="resend-btn" class="btn btn-secondary" style="width: 100%;">
                Resend Verification Email
            </button>

            <p style="margin-top: 20px; font-size: 14px; color: #666;">
                Didn't receive the email? Check your spam folder or click resend above.
            </p>
        </div>

        <!-- Email Verified -->
        <div id="verified-box" class="success-box" style="display: none;">
            <div class="icon">‚úÖ</div>
            <h2>Email Verified!</h2>
            <p>Your email has been successfully verified.</p>
            <p id="verified-message">You can now complete your organisation setup.</p>

            <button id="continue-btn" class="btn" style="width: 100%; margin-top: 20px;">
                Continue to Organisation Setup
            </button>

            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                Already completed setup? <a href="/login" style="color: #007bff;">Sign in here</a>
            </p>
        </div>

        <!-- Checking Status -->
        <div id="loading-spinner" class="loading-spinner">
            <div class="spinner"></div>
            <p style="margin-top: 15px; color: #666;">Checking verification status...</p>
        </div>

        <!-- Warning -->
        <div class="warning-box">
            <strong>‚ö†Ô∏è Important:</strong> The verification link expires in 24 hours. 
            If it expires, you'll need to request a new one.
        </div>
    </div>

    <!-- Load Supabase configuration from server -->
    <script src="/register-config.js"></script>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        const supabaseUrl = window.SUPABASE_URL;
        const supabaseKey = window.SUPABASE_ANON_KEY;

        if (!supabaseUrl || !supabaseKey) {
            console.error('Supabase configuration missing');
            alert('Configuration error. Please contact administrator.');
        }

        const supabase = createClient(supabaseUrl, supabaseKey);

        const pendingBox = document.getElementById('pending-box');
        const verifiedBox = document.getElementById('verified-box');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resendBtn = document.getElementById('resend-btn');
        const continueBtn = document.getElementById('continue-btn');
        const emailDisplay = document.getElementById('user-email');

        // Get email from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');

        if (email) {
            emailDisplay.textContent = email;
        }

        // Check if user is already verified
        async function checkVerificationStatus() {
            try {
                loadingSpinner.style.display = 'block';
                pendingBox.style.display = 'none';

                const { data: { session }, error } = await supabase.auth.getSession();

                if (error) throw error;

                if (session && session.user) {
                    // User is logged in, check if email is verified
                    const isVerified = session.user.email_confirmed_at !== null;
                    
                    if (isVerified) {
                        showVerified();
                    } else {
                        showPending();
                    }
                } else {
                    // Not logged in yet, show pending
                    showPending();
                }
            } catch (error) {
                console.error('Error checking verification:', error);
                showPending();
            }
        }

        function showPending() {
            loadingSpinner.style.display = 'none';
            pendingBox.style.display = 'block';
            verifiedBox.style.display = 'none';
        }

        function showVerified() {
            loadingSpinner.style.display = 'none';
            pendingBox.style.display = 'none';
            verifiedBox.style.display = 'block';
        }

        // Resend verification email
        resendBtn.addEventListener('click', async () => {
            if (!email) {
                alert('Email address not found. Please register again.');
                window.location.href = '/register';
                return;
            }

            resendBtn.disabled = true;
            resendBtn.textContent = 'Sending...';

            try {
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: email,
                    options: {
                        emailRedirectTo: `${window.location.origin}/verify-email`
                    }
                });

                if (error) throw error;

                alert('Verification email sent! Please check your inbox.');
                resendBtn.textContent = 'Email Sent!';
                
                setTimeout(() => {
                    resendBtn.disabled = false;
                    resendBtn.textContent = 'Resend Verification Email';
                }, 5000);

            } catch (error) {
                console.error('Resend error:', error);
                alert('Failed to resend email: ' + error.message);
                resendBtn.disabled = false;
                resendBtn.textContent = 'Resend Verification Email';
            }
        });

        // Continue to organisation setup
        continueBtn.addEventListener('click', () => {
            window.location.href = '/complete-setup';
        });

        // Listen for auth state changes (when user clicks verification link)
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('Auth event:', event);
            
            if (event === 'SIGNED_IN' && session) {
                const isVerified = session.user.email_confirmed_at !== null;
                if (isVerified) {
                    showVerified();
                }
            }
        });

        // Check status on page load
        checkVerificationStatus();

        // Poll for verification status every 5 seconds
        setInterval(() => {
            if (pendingBox.style.display !== 'none') {
                checkVerificationStatus();
            }
        }, 5000);
    </script>
</body>

</html>
